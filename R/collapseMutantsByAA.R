#' Collapse counts by mutated amino acid
#'
#' @param se A \code{\link[SummarizedExperiment]{SummarizedExperiment}}
#'     generated by \code{\link{summarizeExperiment}}
#' @param nameCol A character scalar providing the column of 
#'     \code{rowData(se)} that contains the amino acid mutant names (that will 
#'     be the new row names).
#'
#' @return A \code{\link[SummarizedExperiment]{SummarizedExperiment}} where
#'     counts have been aggregated by the mutated amino acid(s).
#'
#' @author Charlotte Soneson, Michael Stadler
#'
#' @export
#'
#' @importFrom Matrix.utils aggregate.Matrix
#' @importFrom utils relist
#' @importFrom S4Vectors unstrsplit metadata
#' @importFrom SummarizedExperiment assays rowData SummarizedExperiment colData
#' @importFrom dplyr across everything group_by summarize
#' @importFrom tibble column_to_rownames
#'
collapseMutantsByAA <- function(se, nameCol = "mutantNameAA") {
    .assertVector(x = se, type = "SummarizedExperiment")
    .assertScalar(x = nameCol, type = "character")
    
    ## Collapse assays
    aList <- lapply(SummarizedExperiment::assays(se), function(a) {
        Matrix.utils::aggregate.Matrix(
            x = a,
            groupings = factor(SummarizedExperiment::rowData(se)[[nameCol]]),
            fun = "colSums")
    })
    
    ## Collapse rowData - simple columns
    rd <- as.data.frame(SummarizedExperiment::rowData(se)) %>%
        dplyr::group_by(.data[[nameCol]]) %>%
        dplyr::summarize(
            dplyr::across(c("mutantName", "sequence", "sequenceAA",
                            "mutationTypes"), 
                          function(x) gsub(",$", "", gsub("^,", "", paste(unique(unlist(strsplit(paste(x, collapse = ","), ","))), collapse = ",")))),
            dplyr::across(c("minNbrMutBases", "minNbrMutCodons",
                            "minNbrMutAAs"),
                          function(x) min(x)),
            dplyr::across(c("maxNbrMutBases", "maxNbrMutCodons",
                            "maxNbrMutAAs"),
                          function(x) max(x)),
            dplyr::across(c("nbrMutBases", "nbrMutCodons",
                            "nbrMutAAs"),
                          function(x) paste(sort(unique(unlist(x))), 
                                            collapse = ",")))
    
    rd <- S4Vectors::DataFrame(rd)
    rownames(rd) <- rd[[nameCol]]
    
    ## List columns (varLengths columns are not interpretable on the AA level,
    ## so will be removed)
    for (cl in c("nbrMutBases", "nbrMutCodons", "nbrMutAAs")) {
        rd[[cl]] <- as(strsplit(rd[[cl]], ","), "IntegerList")
    }
    
    ## Create SummarizedExperiment
    rn1 <- rownames(aList[[1]])
    cn1 <- colnames(aList[[1]])
    for (i in seq_along(aList)) {
        stopifnot(all(rownames(aList[[i]]) == rn1))
        stopifnot(all(colnames(aList[[i]]) == cn1))
    }
    stopifnot(cn1 == rownames(SummarizedExperiment::colData(se)))
    SummarizedExperiment::SummarizedExperiment(
        assays = aList,
        colData = SummarizedExperiment::colData(se),
        metadata = S4Vectors::metadata(se),
        rowData = rd[rn1, ]
    )
}